CREATE DATABASE DB2023Team01;
USE DB2023Team01;

### 1. DEPARTMENT: 학원 내 부서(직급)에 대한 정보
# 테이블 생성
CREATE TABLE DB2023_DEPARTMENT(
    dp_type INT AUTO_INCREMENT,
    dp_nm VARCHAR(30) NOT NULL,
    upper_dp_type INT,
    PRIMARY KEY(dp_type),
    FOREIGN KEY(upper_dp_type) REFERENCES DB2023_DEPARTMENT(dp_type) # 자기참조
);

# 데이터 삽입
INSERT INTO DB2023_DEPARTMENT (dp_nm, upper_dp_type) VALUES
('원장',NULL),
('전임강사',NULL),
('데스크실장',1),
('수업조교',2);


### 2. MEMBER: 직원정보
# 테이블 생성 
CREATE TABLE DB2023_MEMBER(
  m_id INT AUTO_INCREMENT,
  dp_type INT,
  m_nm VARCHAR(30) NOT NULL, 
  m_ph VARCHAR(20) UNIQUE,
  salary_detail INT NOT NULL,
  work_in_ymd DATE,
  work_status varchar(3) DEFAULT 'in',
  PRIMARY KEY (m_id),
  FOREIGN KEY(dp_type) references DB2023_DEPARTMENT(dp_type)
);

# 데이터 삽입 – 입사
INSERT INTO DB2023_MEMBER(dp_type, m_nm, m_ph, salary_detail, work_in_ymd) VALUES
(1, '백여진', '010-5628-4559', '4000000', '2023-01-01'),
(3, '표상아', '010-7421-2057', '2500000', '2023-01-01'),
(3, '박성한', '010-8058-4857', '2400000', '2023-01-01'),
(2, '송경화', '010-4267-9583', '3200000', '2023-01-01'),
(2, '권보나', '010-6775-7018', '2900000', '2023-01-01'),
(2, '남궁훈', '010-5861-9648', '3500000', '2023-01-01'),
(2, '황혜림', '010-5858-6078', '3500000', '2023-03-01'),
(3, '문이레', '010-7532-3312', '2400000', '2023-04-01'),
(4, '노우리', '010-8009-4223', '1300000', '2023-04-01'),
(4, '심여름', '010-7668-2139', '1400000', '2023-04-01'),
(4, '서강민', '010-9898-6788', '1500000', '2023-04-01');

# 인덱스 생성
ALTER TABLE DB2023_MEMBER ADD INDEX idx_m_id(m_id);


### 3. TUITION: 수강료
# 테이블 생성
CREATE TABLE DB2023_TUITION (
    rec_grade INT,
    once_fee INT NOT NULL,
    PRIMARY KEY (rec_grade)
);

# 데이터 삽입
INSERT INTO DB2023_TUITION VALUES
(1, 100000),
(2, 150000),
(3, 200000);

# 인덱스 생성
ALTER TABLE DB2023_TUITION ADD INDEX idx_tuition(once_fee);


### 4. COURSE: 강좌 테이블
# 테이블 생성
CREATE TABLE DB2023_COURSE (
    c_id VARCHAR(5),
    rec_grade INT NOT NULL,
    m_id INT NOT NULL,
    c_nm VARCHAR(30) NOT NULL,
    week_day VARCHAR(20),
    room INT,
    start_time TIME,
    end_time TIME,
    PRIMARY KEY (c_id),
    FOREIGN KEY (rec_grade) REFERENCES DB2023_TUITION(rec_grade) ON UPDATE CASCADE ON DELETE CASCADE,
    FOREIGN KEY (m_id) REFERENCES DB2023_MEMBER(m_id) 
);

# 데이터 삽입
INSERT INTO DB2023_COURSE VALUES
('11N10',1,5,'내신_수상','화토',402,'11:00:00','12:30:00'),
('21N11',1,5,'내신_수하','수금',403,'19:45:00','21:15:00'),
('10S12',1,5,'수능_수상','수금',409,'16:15:00','17:45:00'),
('20S13',1,5,'수능_수하','월수',404,'16:15:00','17:45:00'),
('32N07',2,6,'내신_수1','수금',406,'18:00:00','19:30:00'),
('42N06',2,6,'내신_수2','화목',405,'18:00:00','19:30:00'),
('30S09',2,6,'수능_수1','화목',402,'18:00:00','19:30:00'),
('40S08',2,6,'수능_수2','월수',404,'18:00:00','19:30:00'),
('73N03',3,1,'내신_기하','월목',405,'19:45:00','21:15:00'),
('53N00',3,4,'내신_미적분','월수',407,'19:45:00','21:15:00'),
('63N02',3,1,'내신_확통','수금',402,'19:45:00','21:15:00'),
('70S05',3,1,'수능_기하','월금',408,'19:45:00','21:15:00'),
('50S01',3,4,'수능_미적분','화목',403,'19:45:00','21:15:00'),
('60S04',3,1,'수능_확통','토일',401,'11:00:00','12:30:00');

# 인덱스 생성
ALTER TABLE DB2023_COURSE ADD INDEX idx_c_id(c_id);


### 5. STUDENT: 재원생 정보
# 테이블 생성
CREATE TABLE DB2023_STUDENT (
    st_id INT AUTO_INCREMENT, 
    st_nm VARCHAR(10) NOT NULL,
    st_ph VARCHAR(20),
    parent_ph VARCHAR(20),
    school_nm VARCHAR(20) NOT NULL,
    school_year INT CHECK (school_year IN (1, 2, 3)),
    study_in_ymd DATE NOT NULL,
    study_status VARCHAR(5) DEFAULT 'in',
    PRIMARY KEY (st_id)
);

# 데이터 삽입
INSERT INTO DB2023_STUDENT(st_nm, st_ph, parent_ph, school_nm, school_year, study_in_ymd) VALUES
('서이경', '010-2857-1657', '010-1483-9832', '표강', 1, '2023-01-01'),
('정보라', '010-4243-4337', '010-2441-4556', '아현', 3, '2023-01-01'),
('정수빈', '010-1123-4562', '010-2112-4536', '미리내', 1, '2023-01-01'),
('박란', '010-3972-2898', '010-1921-2456', '라온', 2, '2023-01-01'),
('강윤재', '010-2312-3453', '010-2331-2356', '고운', 2, '2023-01-01'),
('백민서', '010-1007-2015', '010-2675-1659', '미리내', 3, '2023-01-01'),
('정현', '010-1674-2712', '010-2232-5967', '휘경', 3, '2023-01-25'),
('성혜린', '010-1948-4949', '010-1875-2454', '별빛', 1, '2023-02-01'),
('유혁', '010-1433-0028', '010-3703-6491', '송화', 2, '2023-02-03'),
('조민하', '010-3131-4564', '010-3313-3764', '혜화', 2, '2023-02-03'),
('표인준', '010-2533-2777', '010-2541-1987', '혜화', 1, '2023-02-04'),
('하유리', '010-2506-0132', '010-3236-9812', '고운', 3, '2023-02-08'),
('강승호', '010-1123-8768', '010-1232-1789', '고운', 1, '2023-02-12'),
('허샘', '010-3215-8478', '010-3771-3309', '송화', 2, '2023-02-15'),
('류은아', '010-3221-1349', '010-3823-1456', '고운', 3, '2023-03-04'),
('고연우', '010-3121-3146', '010-3192-3562', '미리내', 3, '2023-03-12'),
('배재신', '010-3834-4701', '010-1999-5390', '별빛', 3, '2023-03-14'),
('홍요한', '010-2793-9712', '010-3479-9685', '고운', 3, '2023-03-18'),
('심가영', '010-2199-6611', '010-2538-6827', '휘경', 3, '2023-03-18'),
('선우아영', '010-2332-2110', '010-2933-1428', '미리내', 2, '2023-03-27'),
('류단비', '010-3823-1456', '010-3823-1456', '고운', 1, '2023-04-05'),
('남한결', '010-2075-1349', '010-1119-2612', '표강', 1, '2023-04-14'),
('박재하', '010-1221-8098', '010-1921-2456', '혜화', 1, '2023-04-14'),
('노현승', '010-2342-4151', '010-2318-6019', '표강', 2, '2023-04-27'),
('황다운', '010-3490-6329', '010-3108-9911', '송화', 3, '2023-04-29'),
('임나길', '010-3251-3548', '010-1797-1261', '라온', 2, '2023-05-01'),
('백대웅', '010-1231-9073', '010-1203-1978', '고운', 2, '2023-05-06'),
('오하나', '010-3558-8413', '010-3043-4281', '미리내', 1, '2023-05-07'),
('강재인', '010-2112-0056', '010-2706-6835', '아현', 2, '2023-05-09'),
('하웅', '010-3790-4496', '010-1824-7707', '아현', 1, '2023-05-15');

# 인덱스 생성
ALTER TABLE DB2023_STUDENT ADD INDEX idx_st_id(st_id);


### 6. ST_CLASS_LOG: 학생 수강 정보

# 테이블 생성 
CREATE TABLE DB2023_ST_CLASS_LOG(
    e_id   INT AUTO_INCREMENT,
    st_id   INT,
    c_id   VARCHAR(5) NOT NULL,
    m_id INT NOT NULL,
    start_ymd   DATE,
    end_ymd   DATE,
    PRIMARY KEY(e_id),
    FOREIGN KEY(st_id) REFERENCES DB2023_STUDENT(st_id),
    FOREIGN KEY(c_id) REFERENCES DB2023_COURSE(c_id),
    FOREIGN KEY(m_id) REFERENCES DB2023_MEMBER(m_id)
);

# 데이터 삽입
INSERT INTO DB2023_ST_CLASS_LOG (st_id, c_id, m_id, start_ymd) VALUES
(21, '10S12', 5, '2023-04-05'),
(8, '10S12', 5, '2023-02-01'),
(22, '10S12', 5, '2023-04-14'),
(28, '10S12', 5, '2023-05-07'),
(30, '10S12', 5, '2023-05-15'),
(1, '10S12', 5, '2023-01-01'),
(13, '21N11', 5, '2023-02-12'),
(11, '21N11', 5, '2023-02-04'),
(23, '21N11', 5, '2023-04-14'),
(3, '21N11', 5, '2023-01-01'),
(4, '40S08', 6, '2023-01-01'),
(14, '40S08', 6, '2023-02-15'),
(24, '40S08', 6, '2023-04-27'),
(9, '40S08', 6, '2023-02-03'),
(29, '40S08', 6, '2023-05-09'),
(26, '42N06', 6, '2023-05-01'),
(20, '42N06', 6, '2023-03-27'),
(27, '42N06', 6, '2023-05-06'),
(5, '42N06', 6, '2023-01-01'),
(10, '42N06', 6, '2023-02-03'),
(6, '50S01', 4, '2023-01-01'),
(7, '50S01', 4, '2023-01-25'),
(19, '50S01', 7, '2023-03-18'),
(18, '50S01', 7, '2023-03-18'),
(12, '50S01', 4, '2023-02-08'),
(15, '73N03', 1, '2023-03-04'),
(16, '73N03', 1, '2023-03-12'),
(2, '73N03', 1, '2023-01-01'),
(17, '73N03', 1, '2023-03-14'),
(25, '73N03', 1, '2023-04-29');


### 7. ATTENDANCE_TYPE: 출석 횟수(-> 이후 payback을 위한 테이블)
# 테이블 생성
CREATE TABLE DB2023_ATTENDANCE_TYPE(
    a_id INT AUTO_INCREMENT,
    att_count INT NOT NULL,
    PRIMARY KEY(a_id)
);
# 데이터 삽입
INSERT INTO DB2023_ATTENDANCE_TYPE (att_count) VALUES
(0),
(1),
(2),
(3),
(4),
(5),
(6),
(7),
(8);


### 8. PAYMENT: 수강료 납부

# 테이블 생성 
CREATE TABLE DB2023_PAYMENT(
    p_id   INT AUTO_INCREMENT,
    e_id   INT,
    a_id   INT NOT NULL,
    mon   INT NOT NULL,
    fee   BIGINT NOT NULL, 
    pay_ymd   DATE,
    pay_back   BIGINT DEFAULT 0,
    payback_ymd   DATE,
    PRIMARY KEY(p_id),
    FOREIGN KEY(e_id) REFERENCES DB2023_ST_CLASS_LOG(e_id),
    FOREIGN KEY(a_id) REFERENCES DB2023_ATTENDANCE_TYPE(a_id)
);

# 데이터 삽입
INSERT INTO DB2023_PAYMENT(e_id, a_id, mon, fee, pay_ymd, pay_back, payback_ymd) VALUES
('22', '1', '1', '1600000', '2023.01.25', '1400000', '2023.02.01'),
('11', '8', '1', '1200000', '2023.01.01', '0', '2023.02.01'),
('6', '8', '1', '800000', '2023.01.01', '0', '2023.02.01'),
('10', '8', '1', '800000', '2023.01.01', '0', '2023.02.01'),
('19', '8', '1', '1200000', '2023.01.01', '0', '2023.02.01'),
('28', '8', '1', '1600000', '2023.01.01', '0', '2023.02.01'),
('21', '8', '1', '1600000', '2023.01.01', '0', '2023.02.01'),
('6', '8', '2', '800000', '2023.02.01', '0', '2023.03.01'),
('11', '8', '2', '1200000', '2023.02.01', '0', '2023.03.01'),
('21', '8', '2', '1600000', '2023.02.01', '0', '2023.03.01'),
('10', '8', '2', '800000', '2023.02.01', '0', '2023.03.01'),
('19', '8', '2', '1200000', '2023.02.01', '0', '2023.03.01'),
('28', '8', '2', '1600000', '2023.02.01', '0', '2023.03.01'),
('22', '8', '2', '1600000', '2023.02.01', '0', '2023.03.01'),
('2', '8', '2', '800000', '2023.02.01', '0', '2023.03.01'),
('20', '7', '2', '1200000', '2023.02.03', '150000', '2023.03.01'),
('14', '7', '2', '1200000', '2023.02.03', '150000', '2023.03.01'),
('8', '7', '2', '800000', '2023.02.04', '100000', '2023.03.01'),
('25', '6', '2', '1600000', '2023.02.08', '400000', '2023.03.01'),
('7', '5', '2', '800000', '2023.02.12', '300000', '2023.03.01'),
('12', '4', '2', '1200000', '2023.02.15', '600000', '2023.03.01'),
('26', '8', '3', '1600000', '2023.03.04', '0', '2023.04.01'),
('11', '8', '3', '1200000', '2023.03.01', '0', '2023.04.01'),
('21', '8', '3', '1600000', '2023.03.01', '0', '2023.04.01'),
('6', '8', '3', '800000', '2023.03.01', '0', '2023.04.01'),
('19', '8', '3', '1200000', '2023.03.01', '0', '2023.04.01'),
('28', '8', '3', '1600000', '2023.03.01', '0', '2023.04.01'),
('22', '8', '3', '1600000', '2023.03.01', '0', '2023.04.01'),
('10', '8', '3', '800000', '2023.03.01', '0', '2023.04.01'),
('14', '8', '3', '1200000', '2023.03.01', '0', '2023.04.01'),
('20', '8', '3', '1200000', '2023.03.01', '0', '2023.04.01'),
('2', '8', '3', '800000', '2023.03.01', '0', '2023.04.01'),
('25', '8', '3', '1600000', '2023.03.01', '0', '2023.04.01'),
('8', '8', '3', '800000', '2023.03.01', '0', '2023.04.01'),
('12', '8', '3', '1200000', '2023.03.01', '0', '2023.04.01'),
('29', '6', '3', '1600000', '2023.03.14', '400000', '2023.04.01'),
('27', '6', '3', '1600000', '2023.03.12', '400000', '2023.04.01'),
('7', '8', '3', '800000', '2023.03.01', '0', '2023.04.01'),
('24', '4', '3', '1600000', '2023.03.18', '800000', '2023.04.01'),
('23', '4', '3', '1600000', '2023.03.18', '800000', '2023.04.01'),
('17', '2', '3', '1200000', '2023.03.27', '900000', '2023.04.01'),
('9', '5', '4', '800000', '2023.04.14', '300000', '2023.05.01'),
('3', '5', '4', '800000', '2023.04.14', '300000', '2023.05.01'),
('27', '6', '4', '1600000', '2023.04.01', '400000', '2023.05.01'),
('1', '8', '4', '800000', '2023.04.05', '0', '2023.05.01'),
('11', '8', '4', '1200000', '2023.04.01', '0', '2023.05.01'),
('21', '8', '4', '1600000', '2023.04.01', '0', '2023.05.01'),
('6', '8', '4', '800000', '2023.04.01', '0', '2023.05.01'),
('19', '8', '4', '1200000', '2023.04.01', '0', '2023.05.01'),
('28', '8', '4', '1600000', '2023.04.01', '0', '2023.05.01'),
('10', '8', '4', '800000', '2023.04.01', '0', '2023.05.01'),
('14', '8', '4', '1200000', '2023.04.01', '0', '2023.05.01'),
('20', '8', '4', '1200000', '2023.04.01', '0', '2023.05.01'),
('2', '8', '4', '800000', '2023.04.01', '0', '2023.05.01'),
('25', '8', '4', '1600000', '2023.04.01', '0', '2023.05.01'),
('8', '8', '4', '800000', '2023.04.01', '0', '2023.05.01'),
('12', '8', '4', '1200000', '2023.04.01', '0', '2023.05.01'),
('26', '8', '4', '1600000', '2023.04.01', '0', '2023.05.01'),
('29', '8', '4', '1600000', '2023.04.01', '0', '2023.05.01'),
('24', '8', '4', '1600000', '2023.04.01', '0', '2023.05.01'),
('23', '8', '4', '1600000', '2023.04.01', '0', '2023.05.01'),
('17', '8', '4', '1200000', '2023.04.01', '0', '2023.05.01'),
('7', '8', '4', '800000', '2023.04.01', '0', '2023.05.01'),
('3', '4', '5', '800000', '2023.05.01', '400000', '2023.06.01'),
('5', '5', '5', '800000', '2023.05.15', '300000', '2023.06.01'),
('18', '7', '5', '1200000', '2023.05.06', '150000', '2023.06.01'),
('4', '7', '5', '800000', '2023.05.07', '100000', '2023.06.01'),
('15', '7', '5', '1200000', '2023.05.09', '150000', '2023.06.01'),
('13', '8', '5', '1200000', '2023.05.01', '0', '2023.06.01'),
('16', '8', '5', '1200000', '2023.05.01', '0', '2023.06.01'),
('11', '8', '5', '1200000', '2023.05.01', '0', '2023.06.01'),
('21', '8', '5', '1600000', '2023.05.01', '0', '2023.06.01'),
('6', '8', '5', '800000', '2023.05.01', '0', '2023.06.01'),
('19', '8', '5', '1200000', '2023.05.01', '0', '2023.06.01'),
('28', '8', '5', '1600000', '2023.05.01', '0', '2023.06.01'),
('10', '8', '5', '800000', '2023.05.01', '0', '2023.06.01'),
('14', '8', '5', '1200000', '2023.05.01', '0', '2023.06.01'),
('20', '8', '5', '1200000', '2023.05.01', '0', '2023.06.01'),
('2', '8', '5', '800000', '2023.05.01', '0', '2023.06.01'),
('25', '8', '5', '1600000', '2023.05.01', '0', '2023.06.01'),
('8', '8', '5', '800000', '2023.05.01', '0', '2023.06.01'),
('26', '8', '5', '1600000', '2023.05.01', '0', '2023.06.01'),
('29', '8', '5', '1600000', '2023.05.01', '0', '2023.06.01'),
('24', '8', '5', '1600000', '2023.05.01', '0', '2023.06.01'),
('23', '8', '5', '1600000', '2023.05.01', '0', '2023.06.01'),
('17', '8', '5', '1200000', '2023.05.01', '0', '2023.06.01'),
('7', '8', '5', '800000', '2023.05.01', '0', '2023.06.01'),
('1', '8', '5', '800000', '2023.05.01', '0', '2023.06.01'),
('30', '8', '5', '1600000', '2023.05.01', '0', '2023.06.01'),
('9', '8', '5', '800000', '2023.05.01', '0', '2023.06.01'),
('6', '8', '6', '800000', '2023.06.01', '0', NULL),
('10', '8', '6', '800000', '2023.06.01', '0', NULL),
('11', '8', '6', '1200000', '2023.06.01', '0', NULL),
('19', '8', '6', '1200000', '2023.06.01', '0', NULL),
('21', '8', '6', '1600000', '2023.06.01', '0', NULL),
('28', '8', '6', '1600000', '2023.06.01', '0', NULL),
('2', '8', '6', '800000', '2023.06.01', '0', NULL),
('14', '8', '6', '1200000', '2023.06.01', '0', NULL),
('20', '8', '6', '1200000', '2023.06.01', '0', NULL),
('8', '8', '6', '800000', '2023.06.01', '0', NULL),
('25', '8', '6', '1600000', '2023.06.01', '0', NULL),
('7', '8', '6', '800000', '2023.06.01', '0', NULL),
('26', '8', '6', '1600000', '2023.06.01', '0', NULL),
('29', '8', '6', '1600000', '2023.06.01', '0', NULL),
('24', '8', '6', '1600000', '2023.06.01', '0', NULL),
('23', '8', '6', '1600000', '2023.06.01', '0', NULL),
('17', '8', '6', '1200000', '2023.06.01', '0', NULL),
('1', '8', '6', '800000', '2023.06.01', '0', NULL),
('9', '8', '6', '800000', '2023.06.01', '0', NULL),
('13', '8', '6', '1200000', '2023.06.01', '0', NULL),
('30', '8', '6', '1600000', '2023.06.01', '0', NULL),
('16', '8', '6', '1200000', '2023.06.01', '0', NULL),
('18', '8', '6', '1200000', '2023.06.01', '0', NULL),
('4', '8', '6', '800000', '2023.06.01', '0', NULL),
('15', '8', '6', '1200000', '2023.06.01', '0', NULL),
('5', '8', '6', '800000', '2023.06.01', '0', NULL),
('22', '8', '4', '1600000', '2023.04.01', '0', '2023.05.01'),
('22', '8', '5', '1600000', '2023.05.01', '0', '2023.06.01'),
('22', '8', '6', '1600000', '2023.06.01', '0', NULL);

# -------------------------------------------

### 뷰 생성
CREATE OR REPLACE VIEW DB2023_MEMBER_VIEW AS 
	SELECT m_id, D.dp_nm, m_nm, m_ph, salary_detail, work_in_ymd, work_status
	FROM DB2023_MEMBER AS M USE INDEX(idx_m_id)
	JOIN DB2023_DEPARTMENT AS D ON M.dp_type = D.dp_type;
    
CREATE OR REPLACE VIEW DB2023_COURSE_VIEW AS
	SELECT C.C_id AS c_id, C.c_nm AS course, C.rec_grade AS grade, 
		   M.m_nm AS tr, C.m_id AS t_id, C.week_day AS dow, 
           C.room, C.start_time, C.end_time
	FROM DB2023_COURSE C USE INDEX(idx_c_id) # 여기서 인덱스 사용
    LEFT OUTER JOIN DB2023_MEMBER M USE INDEX(idx_m_id)
		ON M.m_id = C.m_id;

CREATE OR REPLACE VIEW DB2023_PAYMENT_VIEW AS 
	SELECT P.p_id AS p_id, S.st_nm AS s_nm, C.c_nm AS c_nm, 
		P.a_id AS a_id, p.mon AS mon, P.fee AS fee, 
		P.pay_ymd pay_ymd, P.pay_back AS pay_back, P.payback_ymd AS payback_ymd 
	FROM DB2023_PAYMENT P 
	LEFT OUTER JOIN DB2023_ST_CLASS_LOG L ON P.e_id = L.e_id 
	LEFT OUTER JOIN DB2023_STUDENT S USE INDEX(idx_st_id) ON L.st_id = S.st_id 
	LEFT OUTER JOIN DB2023_COURSE C  USE INDEX(idx_c_id) ON L.c_id = C.c_id;
    